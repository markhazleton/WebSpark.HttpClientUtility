name: Publish HttpClientUtility NuGet Packages

on:
  push:
    tags:
      - "v*.*.*" # Trigger on version tags like v1.0.0, v2.0.0
    branches: [main] # Still run build/test on main branch
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

jobs:
  build-test-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create GitHub releases
      checks: write # Needed for dorny/test-reporter to create check runs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for GitVersion

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Setup .NET 10 SDK (Preview)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
          dotnet-quality: preview

      - name: Display installed .NET SDKs
        run: dotnet --list-sdks

      - name: Restore dependencies
        run: dotnet restore WebSpark.HttpClientUtility.sln

      - name: Build solution
        run: dotnet build WebSpark.HttpClientUtility.sln --configuration Release --no-restore

      - name: Run tests on .NET 8
        continue-on-error: false
        run: dotnet test WebSpark.HttpClientUtility.sln --configuration Release --no-build --framework net8.0 --verbosity normal --logger "trx" --collect:"XPlat Code Coverage" --results-directory ./TestResults/net8.0

      - name: Run tests on .NET 9
        continue-on-error: false
        run: dotnet test WebSpark.HttpClientUtility.sln --configuration Release --no-build --framework net9.0 --verbosity normal --logger "trx" --collect:"XPlat Code Coverage" --results-directory ./TestResults/net9.0

      - name: Run tests on .NET 10
        continue-on-error: false
        run: dotnet test WebSpark.HttpClientUtility.sln --configuration Release --no-build --framework net10.0 --verbosity normal --logger "trx" --collect:"XPlat Code Coverage" --results-directory ./TestResults/net10.0

      - name: List test results (debug)
        if: always()
        run: |
          echo "TestResults directory structure:"
          ls -la ./TestResults || echo "TestResults directory not found"
          echo ""
          echo "Searching for TRX files:"
          find ./TestResults -type f -name "*.trx" 2>/dev/null || echo "No .trx files found"
          echo ""
          echo "All files in TestResults:"
          find ./TestResults -type f 2>/dev/null || echo "TestResults directory empty or not found"
          echo ""
          echo "Working directory:"
          pwd
          echo ""
          echo "Directory listing:"
          ls -la

      - name: Verify TRX files exist before reporting
        if: always()
        run: |
          TRX_COUNT=$(find ./TestResults -name "*.trx" 2>/dev/null | wc -l)
          echo "Found $TRX_COUNT TRX files"
          if [ $TRX_COUNT -eq 0 ]; then
            echo "WARNING: No TRX files found for test reporting"
            echo "This may cause the test reporter to fail"
          fi

      - name: Test Report
        uses: dorny/test-reporter@v1
        if: always() # run this step even if previous steps failed
        continue-on-error: true # Don't fail workflow if test reporter has issues
        with:
          name: .NET Tests # Name of the check run which will be created
          path: 'TestResults/**/*.trx' # Path to test results (single quotes for glob)
          reporter: dotnet-trx # Format of test results
          fail-on-error: false # Do not fail the workflow run if tests fail

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ./TestResults
          if-no-files-found: warn

      - name: Generate code coverage report
        uses: danielpalme/ReportGenerator-GitHub-Action@5.2.4
        with:
          reports: "./TestResults/**/coverage.cobertura.xml"
          targetdir: "./CoverageReport"
          reporttypes: "HtmlInline;Cobertura;Badges"
          verbosity: "Info"

      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./CoverageReport
          if-no-files-found: warn

      - name: Pack base package
        run: dotnet pack WebSpark.HttpClientUtility/WebSpark.HttpClientUtility.csproj --configuration Release --no-build --output ./nupkg

      - name: Pack crawler package
        run: dotnet pack WebSpark.HttpClientUtility.Crawler/WebSpark.HttpClientUtility.Crawler.csproj --configuration Release --no-build --output ./nupkg

      - name: Verify package contents
        run: |
          echo "Base package contents:"
          unzip -l ./nupkg/WebSpark.HttpClientUtility.*.nupkg | grep "lib/"
          echo ""
          echo "Crawler package contents:"
          unzip -l ./nupkg/WebSpark.HttpClientUtility.Crawler.*.nupkg | grep "lib/"

      - name: Upload NuGet packages artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./nupkg
          if-no-files-found: error

      # Only publish on pushes to version tags, not PRs or branch pushes
      # Both packages are published atomically in the same step
      - name: Publish NuGet packages
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          dotnet nuget push ./nupkg/WebSpark.HttpClientUtility.*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          dotnet nuget push ./nupkg/WebSpark.HttpClientUtility.Crawler.*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

      # Create GitHub Release with CHANGELOG information
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: ./nupkg/*
          body_path: CHANGELOG.md
          token: ${{ secrets.GITHUB_TOKEN }}
