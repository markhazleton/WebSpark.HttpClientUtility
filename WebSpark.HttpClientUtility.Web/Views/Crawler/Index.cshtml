@{
    ViewData["Title"] = "Web Crawler";
}

<div class="row">
    <div class="col-lg-12">
        <h1 class="display-5">üï∑Ô∏è Web Crawler</h1>
        <p class="lead">@ViewData["Description"]</p>
        
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            <strong>Package Split Demo:</strong> This feature uses the <code>WebSpark.HttpClientUtility.Crawler</code> package,
            which extends the base package with web crawling capabilities.
        </div>
        
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Limitations:</strong> This crawler only works with <strong>server-rendered HTML</strong>. 
            Single Page Applications (SPAs) that use JavaScript frameworks like React, Vue, or Angular will not be crawled correctly. 
            Try sites like <code>https://example.com</code>, <code>https://httpbin.org/links/10</code>, or traditional server-rendered websites.
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Crawler Configuration</h5>
            </div>
            <div class="card-body">
                <form id="crawlerForm">
                    <div class="mb-3">
                        <label for="url" class="form-label">Start URL</label>
                        <input type="url" class="form-control" id="url" placeholder="https://example.com" required>
                        <div class="form-text">The URL to start crawling from</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="maxDepth" class="form-label">Max Depth</label>
                            <input type="number" class="form-control" id="maxDepth" value="3" min="1" max="10">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> Depth 1 = home, 2 = links from home, 3 = links from those pages
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="maxPages" class="form-label">Max Pages</label>
                            <input type="number" class="form-control" id="maxPages" value="100" min="1" max="1000">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> Crawler stops when this limit is reached
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="delayMs" class="form-label">Delay (ms)</label>
                            <input type="number" class="form-control" id="delayMs" value="1000" min="100" max="5000" step="100">
                            <div class="form-text">Delay between requests</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="respectRobotsTxt" checked>
                                <label class="form-check-label" for="respectRobotsTxt">
                                    Respect robots.txt
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="discoverFromSitemap" checked>
                                <label class="form-check-label" for="discoverFromSitemap">
                                    <i class="bi bi-file-earmark-code"></i> Discover from sitemap/RSS
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="userAgent" class="form-label">User Agent</label>
                        <input type="text" class="form-control" id="userAgent" value="WebSpark.HttpClientUtility.Crawler/2.0.0">
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="startCrawlBtn">
                            <i class="bi bi-play-circle"></i> Start Crawl
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="mt-4" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-check-circle"></i> Crawl Results</h5>
                </div>
                <div class="card-body">
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="mt-4" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> Crawling in Progress...</h5>
                </div>
                <div class="card-body">
                    <div class="progress" style="height: 30px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <div id="progressText" class="mt-3 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Features</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">‚úÖ <strong>Robots.txt Compliance</strong></li>
                    <li class="mb-2">‚úÖ <strong>HTML Link Extraction</strong></li>
                    <li class="mb-2">‚úÖ <strong>Depth-Limited Crawling</strong></li>
                    <li class="mb-2">‚úÖ <strong>Configurable Delays</strong></li>
                    <li class="mb-2">‚úÖ <strong>Performance Tracking</strong></li>
                    <li class="mb-2">‚úÖ <strong>Error Handling</strong></li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Best Practices</h5>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>Start with small max pages (50-100)</li>
                    <li>Use appropriate delays (1000ms+)</li>
                    <li>Always respect robots.txt</li>
                    <li>Monitor server load</li>
                    <li>Test on your own sites first</li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-code-square"></i> Package Info</h5>
            </div>
            <div class="card-body">
                <p class="small mb-2"><strong>Base Package:</strong></p>
                <code class="d-block mb-3 small">WebSpark.HttpClientUtility</code>
                
                <p class="small mb-2"><strong>Crawler Package:</strong></p>
                <code class="d-block mb-3 small">WebSpark.HttpClientUtility.Crawler</code>
                
                <p class="small mb-0">
                    <strong>DI Registration:</strong>
                </p>
                <pre class="small"><code>services.AddHttpClientUtility();
services.AddHttpClientCrawler();</code></pre>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@@7.0.0/dist/browser/signalr.min.js"></script>
    <script>
        let connection;

        // Initialize SignalR connection
        function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/crawlHub")
                .withAutomaticReconnect()
                .build();

            connection.on("UrlFound", function (message) {
                updateProgressFromMessage(message);
            });

            connection.start().then(() => {
                console.log("SignalR connected");
            }).catch(function (err) {
                console.error("SignalR connection error:", err);
            });
        }

        // Parse and update progress from message
        function updateProgressFromMessage(message) {
            // Message format: "Crawled: X | Queue: Y | Found: url"
            const match = message.match(/Crawled: (\d+) \| Queue: (\d+) \| Found: (.+)/);
            if (match) {
                const crawled = parseInt(match[1]);
                const queue = parseInt(match[2]);
                const url = match[3];
                
                const maxPages = parseInt($('#maxPages').val()) || 50;
                const totalDiscovered = crawled + queue;
                const remaining = Math.max(0, Math.min(queue, maxPages - crawled));
                const percent = Math.min(Math.round((crawled / maxPages) * 100), 100);
                
                $('#progressBar').css('width', percent + '%')
                    .attr('aria-valuenow', percent)
                    .text(percent + '%');
                
                $('#progressText').html(`
                    <div class="row text-center mb-2">
                        <div class="col-4">
                            <h5 class="text-success mb-0">${crawled}</h5>
                            <small class="text-muted">Crawled</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-primary mb-0">${totalDiscovered}</h5>
                            <small class="text-muted">Discovered</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-warning mb-0">${remaining}</h5>
                            <small class="text-muted">Queued</small>
                        </div>
                    </div>
                    <div class="small text-muted mb-1">
                        <i class="bi bi-info-circle"></i> Max Pages: ${maxPages} | 
                        Will stop at: ${Math.min(totalDiscovered, maxPages)}
                    </div>
                    <p class="small mb-0">Latest: <code class="text-break">${url}</code></p>
                `);
            } else if (message.startsWith("Crawl Complete:")) {
                $('#progressBar').removeClass('progress-bar-animated').addClass('bg-success');
                $('#progressText').html(`<p class="text-success mb-0"><i class="bi bi-check-circle"></i> ${message}</p>`);
            }
        }

        // Handle form submission
        $('#crawlerForm').on('submit', async function (e) {
            e.preventDefault();

            const request = {
                url: $('#url').val(),
                maxDepth: parseInt($('#maxDepth').val()),
                maxPages: parseInt($('#maxPages').val()),
                respectRobotsTxt: $('#respectRobotsTxt').is(':checked'),
                discoverFromSitemap: $('#discoverFromSitemap').is(':checked'),
                userAgent: $('#userAgent').val(),
                delayMs: parseInt($('#delayMs').val())
            };

            // Show progress, hide results
            $('#progressSection').show();
            $('#resultsSection').hide();
            $('#progressBar').removeClass('bg-success').addClass('progress-bar-animated')
                .css('width', '0%').attr('aria-valuenow', 0).text('0%');
            $('#progressText').html('<p class="mb-0">Starting crawl...</p>');
            $('#startCrawlBtn').prop('disabled', true).html('<i class="bi bi-hourglass"></i> Crawling...');

            try {
                const response = await fetch('/Crawler/Crawl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(request)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || errorData.message || `HTTP ${response.status}`);
                }

                const result = await response.json();
                displayResults(result);
            } catch (error) {
                console.error('Crawl error:', error);
                $('#resultsContent').html(`
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
                        <p><strong>Message:</strong> ${error.message}</p>
                        <p class="small mb-0">Check the browser console for more details.</p>
                    </div>
                `);
                $('#resultsSection').show();
            } finally {
                $('#progressSection').hide();
                $('#startCrawlBtn').prop('disabled', false).html('<i class="bi bi-play-circle"></i> Start Crawl');
            }
        });

        // Display crawl results
        function displayResults(result) {
            const successCount = result.successfulPages || 0;
            const errorCount = result.failedPages || 0;
            const totalCount = result.totalPages || 0;

            let html = `
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success">${successCount}</h3>
                                <p class="mb-0">Successful</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-danger">${errorCount}</h3>
                                <p class="mb-0">Errors</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary">${totalCount}</h3>
                                <p class="mb-0">Total Pages</p>
                            </div>
                        </div>
                    </div>
                </div>

                <h5 class="mt-4">Crawled Pages:</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 80px;">Status</th>
                                <th style="width: 45%;">URL</th>
                                <th style="width: 35%;">Title</th>
                                <th style="width: 80px;" class="text-center">Links</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const pages = result.crawlResults || [];
            pages.slice(0, 50).forEach(page => {
                const statusBadge = page.isSuccessStatusCode 
                    ? `<span class="badge bg-success">${page.statusCode}</span>` 
                    : `<span class="badge bg-danger">${page.statusCode}</span>`;
                
                const truncateUrl = (url) => {
                    if (url.length > 60) {
                        return url.substring(0, 57) + '...';
                    }
                    return url;
                };
                
                const truncateTitle = (title) => {
                    if (!title || title === 'N/A') return '<em class="text-muted">No title</em>';
                    if (title.length > 50) {
                        return title.substring(0, 47) + '...';
                    }
                    return title;
                };
                
                html += `
                    <tr>
                        <td class="text-center">${statusBadge}</td>
                        <td class="small"><a href="${page.requestPath}" target="_blank" title="${page.requestPath}">${truncateUrl(page.requestPath)}</a></td>
                        <td class="small" title="${page.pageTitle || ''}">${truncateTitle(page.pageTitle)}</td>
                        <td class="text-center"><span class="badge bg-secondary">${page.linksFound || 0}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';

            if (pages.length > 50) {
                html += `<p class="text-muted small">Showing first 50 of ${pages.length} results</p>`;
            }

            $('#resultsContent').html(html);
            $('#resultsSection').show();
        }

        // Initialize on page load
        $(document).ready(function () {
            initializeSignalR();
        });
    </script>
}
