@{
    ViewData["Title"] = "Web Crawler";
}

<div class="row">
    <div class="col-lg-12">
        <h1 class="display-5">üï∑Ô∏è Web Crawler</h1>
        <p class="lead">@ViewData["Description"]</p>
        
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            <strong>Package Split Demo:</strong> This feature uses the <code>WebSpark.HttpClientUtility.Crawler</code> package,
            which extends the base package with web crawling capabilities.
        </div>
        
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Limitations:</strong> This crawler only works with <strong>server-rendered HTML</strong>. 
            Single Page Applications (SPAs) that use JavaScript frameworks like React, Vue, or Angular will not be crawled correctly. 
            Try sites like <code>https://example.com</code>, <code>https://httpbin.org/links/10</code>, or traditional server-rendered websites.
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Crawler Configuration</h5>
            </div>
            <div class="card-body">
                <form id="crawlerForm">
                    <div class="mb-3">
                        <label for="url" class="form-label">Start URL</label>
                        <input type="url" class="form-control" id="url" placeholder="https://example.com" required>
                        <div class="form-text">The URL to start crawling from</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="maxDepth" class="form-label">Max Depth</label>
                            <input type="number" class="form-control" id="maxDepth" value="3" min="1" max="10">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> Depth 1 = home, 2 = links from home, 3 = links from those pages
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="maxPages" class="form-label">Max Pages</label>
                            <input type="number" class="form-control" id="maxPages" value="100" min="1" max="1000">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> Crawler stops when this limit is reached
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="delayMs" class="form-label">Delay (ms)</label>
                            <input type="number" class="form-control" id="delayMs" value="1000" min="100" max="5000" step="100">
                            <div class="form-text">Delay between requests</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="respectRobotsTxt" checked>
                                <label class="form-check-label" for="respectRobotsTxt">
                                    Respect robots.txt
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="discoverFromSitemap" checked>
                                <label class="form-check-label" for="discoverFromSitemap">
                                    <i class="bi bi-file-earmark-code"></i> Discover from sitemap/RSS
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="userAgent" class="form-label">User Agent</label>
                        <input type="text" class="form-control" id="userAgent" value="WebSpark.HttpClientUtility.Crawler/2.0.0">
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="startCrawlBtn">
                            <i class="bi bi-play-circle"></i> Start Crawl
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="mt-4" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-check-circle"></i> Crawl Results</h5>
                </div>
                <div class="card-body">
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="mt-4" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> Crawling in Progress...</h5>
                </div>
                <div class="card-body">
                    <div class="progress" style="height: 30px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <div id="progressText" class="mt-3 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Features</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">‚úÖ <strong>Robots.txt Compliance</strong></li>
                    <li class="mb-2">‚úÖ <strong>HTML Link Extraction</strong></li>
                    <li class="mb-2">‚úÖ <strong>Depth-Limited Crawling</strong></li>
                    <li class="mb-2">‚úÖ <strong>Configurable Delays</strong></li>
                    <li class="mb-2">‚úÖ <strong>Performance Tracking</strong></li>
                    <li class="mb-2">‚úÖ <strong>Error Handling</strong></li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Best Practices</h5>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>Start with small max pages (50-100)</li>
                    <li>Use appropriate delays (1000ms+)</li>
                    <li>Always respect robots.txt</li>
                    <li>Monitor server load</li>
                    <li>Test on your own sites first</li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-code-square"></i> Package Info</h5>
            </div>
            <div class="card-body">
                <p class="small mb-2"><strong>Base Package:</strong></p>
                <code class="d-block mb-3 small">WebSpark.HttpClientUtility</code>
                
                <p class="small mb-2"><strong>Crawler Package:</strong></p>
                <code class="d-block mb-3 small">WebSpark.HttpClientUtility.Crawler</code>
                
                <p class="small mb-0">
                    <strong>DI Registration:</strong>
                </p>
                <pre class="small"><code>services.AddHttpClientUtility();
services.AddHttpClientCrawler();</code></pre>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        console.log("[Crawler] Scripts section loaded - waiting for SignalR module to load...");
        let connection;

        // Wait for SignalR module to load (ES modules load asynchronously)
        function waitForSignalR(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkSignalR = setInterval(() => {
                attempts++;
                if (typeof signalR !== 'undefined') {
                    clearInterval(checkSignalR);
                    console.log(`[Crawler] ‚úÖ SignalR loaded after ${attempts} checks`);
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkSignalR);
                    console.error(`[Crawler] ‚ùå SignalR failed to load after ${maxAttempts} attempts (${maxAttempts * 100}ms)`);
                }
            }, 100);
        }

        // Initialize SignalR connection immediately
        function initializeSignalR() {
            console.log("[Crawler] initializeSignalR called");
            
            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/crawlHub")
                    .withAutomaticReconnect()
                    .configureLogging(signalR.LogLevel.Information)
                    .build();

                console.log("[Crawler] SignalR connection object created");

                // Progress updates during crawl
                connection.on("UrlFound", function (message) {
                    console.log("[Crawler] SignalR UrlFound:", message);
                    updateProgressFromMessage(message);
                });

                // Final results when crawl completes
                connection.on("CrawlResults", function (results) {
                    console.log("[Crawler] SignalR CrawlResults:", results);
                    displayResults(results);
                });

                // Error handling
                connection.on("CrawlError", function (error) {
                    console.error("[Crawler] SignalR CrawlError:", error);
                    document.getElementById('resultsContent').innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="bi bi-exclamation-triangle"></i> Crawl Error</h5>
                            <p><strong>URL:</strong> ${error.url}</p>
                            <p><strong>Error:</strong> ${error.error}</p>
                            <p class="small mb-0">Timestamp: ${error.timestamp}</p>
                        </div>
                    `;
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('progressSection').style.display = 'none';
                    
                    const startBtn = document.getElementById('startCrawlBtn');
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Crawl';
                });

                console.log("[Crawler] Starting SignalR connection...");
                connection.start().then(() => {
                    console.log("[Crawler] ‚úÖ SignalR connected successfully!");
                    console.log("[Crawler] Connection ID:", connection.connectionId);
                }).catch(function (err) {
                    console.error("[Crawler] ‚ùå SignalR connection error:", err);
                    console.error("[Crawler] Error details:", err.message);
                });
            } catch (error) {
                console.error("[Crawler] ‚ùå Error initializing SignalR:", error);
                console.error("[Crawler] Error details:", error.message);
            }
        }

        // Initialize when DOM is ready AND SignalR module is loaded
        if (document.readyState === 'loading') {
            console.log("[Crawler] Waiting for DOM...");
            document.addEventListener('DOMContentLoaded', () => {
                waitForSignalR(initializeSignalR);
            });
        } else {
            console.log("[Crawler] DOM already ready, waiting for SignalR...");
            waitForSignalR(initializeSignalR);
        }

        // Handle form submission
        document.getElementById('crawlerForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            
            console.log("[Crawler] Form submitted");
            
            // Get form values
            const request = {
                url: document.getElementById('url').value,
                maxDepth: parseInt(document.getElementById('maxDepth').value),
                maxPages: parseInt(document.getElementById('maxPages').value),
                delayMs: parseInt(document.getElementById('delayMs').value),
                respectRobotsTxt: document.getElementById('respectRobotsTxt').checked,
                discoverFromSitemap: document.getElementById('discoverFromSitemap').checked,
                userAgent: document.getElementById('userAgent').value
            };

            console.log("[Crawler] Request:", request);

            // Show progress section
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            // Reset progress
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', 0);
            progressBar.textContent = '0%';
            progressBar.classList.add('progress-bar-animated');
            progressBar.classList.remove('bg-success');

            document.getElementById('progressText').innerHTML = '<p class="mb-0">Initializing crawler...</p>';

            // Disable button
            const startBtn = document.getElementById('startCrawlBtn');
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="bi bi-hourglass"></i> Crawling...' ;

            try {
                const response = await fetch('/Crawler/Crawl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(request)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || errorData.message || `HTTP ${response.status}`);
                }

                const result = await response.json();
                
                // Handle 202 Accepted - crawl started in background
                if (response.status === 202) {
                    console.log('[Crawler] Crawl started:', result.message);
                    document.getElementById('progressText').innerHTML = `
                        <p class="mb-0"><i class="bi bi-check-circle text-success"></i> ${result.message}</p>
                        <p class="small mb-0">Watch the progress bar above for real-time updates...</p>
                    `;
                    // Don't call displayResults - let SignalR updates handle it
                    // Results will show when "Crawl Complete" message is received
                } else {
                    // Fallback for synchronous response (shouldn't happen with new code)
                    displayResults(result);
                }
            } catch (error) {
                console.error('[Crawler] Crawl error:', error);
                document.getElementById('resultsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
                        <p><strong>Message:</strong> ${error.message}</p>
                        <p class="small mb-0">Check the browser console for more details.</p>
                    </div>
                `;
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('progressSection').style.display = 'none';
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Crawl';
            }
        });
    </script>
}
