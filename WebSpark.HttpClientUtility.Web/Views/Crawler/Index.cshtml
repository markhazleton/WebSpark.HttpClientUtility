@{
    ViewData["Title"] = "Web Crawler";
}

<div class="container mt-4">

    <div class="row mb-4">
        <div class="col-12">
            <h1>Web Crawler</h1>
            <p class="lead">
                A focused demo of <code>WebSpark.HttpClientUtility.Crawler</code> — the companion NuGet package
                that adds site crawling to the base HTTP utility.
            </p>
        </div>
    </div>

    <div class="row g-4">

        <!-- Left: Form + Results -->
        <div class="col-lg-8">

            <!-- Config card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-play-circle"></i> Run a Crawl</h5>
                </div>
                <div class="card-body">
                    <form id="crawlForm" onsubmit="return false;">
                        <div class="mb-3">
                            <label for="crawlUrl" class="form-label fw-semibold">Start URL</label>
                            <input type="url" id="crawlUrl" class="form-control"
                                   value="https://markhazleton.com" required
                                   placeholder="https://example.com" />
                            <div class="form-text">Crawls only same-domain links. SPAs (React/Vue/Angular) are not supported — use server-rendered sites.</div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-sm-6">
                                <label for="maxPages" class="form-label fw-semibold">Max Pages</label>
                                <select id="maxPages" class="form-select">
                                    <option value="10">10 pages</option>
                                    <option value="20" selected>20 pages</option>
                                    <option value="25">25 pages (max)</option>
                                </select>
                                <div class="form-text">Demo cap: 25 pages</div>
                            </div>
                            <div class="col-sm-6">
                                <label for="maxDepth" class="form-label fw-semibold">Max Depth</label>
                                <select id="maxDepth" class="form-select">
                                    <option value="1">1 — home page only</option>
                                    <option value="2" selected>2 — home + linked pages</option>
                                    <option value="3">3 — one level deeper</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-sm-6">
                                <div class="form-check form-switch mt-1">
                                    <input class="form-check-input" type="checkbox" id="robotsTxt" checked>
                                    <label class="form-check-label" for="robotsTxt">
                                        <i class="bi bi-shield-check text-success"></i> Respect robots.txt
                                    </label>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-check form-switch mt-1">
                                    <input class="form-check-input" type="checkbox" id="sitemapDiscover" checked>
                                    <label class="form-check-label" for="sitemapDiscover">
                                        <i class="bi bi-diagram-3 text-info"></i> Discover from sitemap/RSS
                                    </label>
                                </div>
                            </div>
                        </div>

                        <button type="button" id="crawlBtn" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-play-fill"></i> Start Crawl
                        </button>
                    </form>
                </div>
            </div>

            <!-- Spinner (hidden until crawl starts) -->
            <div id="crawlingState" class="card border-info mb-4" style="display:none;">
                <div class="card-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status" style="width:3rem;height:3rem;">
                        <span class="visually-hidden">Crawling...</span>
                    </div>
                    <h5 id="crawlingMessage" class="mb-1">Crawling...</h5>
                    <p class="text-muted mb-0 small">This may take 10–30 seconds depending on page count and delay settings.</p>
                </div>
            </div>

            <!-- Error state (hidden until error) -->
            <div id="errorState" class="alert alert-danger" style="display:none;">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>Crawl failed:</strong> <span id="errorMessage"></span>
            </div>

            <!-- Results (hidden until complete) -->
            <div id="resultsState" style="display:none;">

                <!-- Summary stats -->
                <div class="row g-3 mb-4" id="statCards">
                    <div class="col-6 col-md-3">
                        <div class="card text-center border-primary h-100">
                            <div class="card-body py-3">
                                <div class="h2 mb-0 fw-bold text-primary" id="statTotal">0</div>
                                <div class="small text-muted">Pages Crawled</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card text-center border-success h-100">
                            <div class="card-body py-3">
                                <div class="h2 mb-0 fw-bold text-success" id="statSuccess">0</div>
                                <div class="small text-muted">Successful</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card text-center border-danger h-100">
                            <div class="card-body py-3">
                                <div class="h2 mb-0 fw-bold text-danger" id="statFailed">0</div>
                                <div class="small text-muted">Failed</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card text-center border-secondary h-100">
                            <div class="card-body py-3">
                                <div class="h2 mb-0 fw-bold" id="statDuration">0s</div>
                                <div class="small text-muted">Duration</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Crawl metadata badges -->
                <div class="mb-3" id="metaBadges"></div>

                <!-- Results table -->
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-table"></i> Crawled Pages</h5>
                        <button class="btn btn-sm btn-outline-light" id="crawlAgainBtn">
                            <i class="bi bi-arrow-clockwise"></i> Crawl Again
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:2.5rem">#</th>
                                    <th>URL &amp; Title</th>
                                    <th style="width:5rem" class="text-center">Status</th>
                                    <th style="width:4rem" class="text-center">Depth</th>
                                    <th style="width:4.5rem" class="text-center">Links</th>
                                    <th style="width:5rem" class="text-end">Time</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <!-- Right: Feature callouts -->
        <div class="col-lg-4">

            <div class="card mb-3">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0"><i class="bi bi-box-seam"></i> Package Setup</h6>
                </div>
                <div class="card-body">
                    <p class="small mb-2 text-muted">Install both packages:</p>
                    <pre class="bg-light p-2 rounded small mb-0"><code>dotnet add package WebSpark.HttpClientUtility
dotnet add package WebSpark.HttpClientUtility.Crawler</code></pre>
                    <hr class="my-2">
                    <p class="small mb-2 text-muted">Register in Program.cs:</p>
                    <pre class="bg-light p-2 rounded small mb-0"><code>services.AddHttpClientUtility();
services.AddHttpClientCrawler();</code></pre>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-stars"></i> Crawler Features</h6>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush small">
                        <li class="list-group-item">
                            <i class="bi bi-shield-check text-success"></i>
                            <strong>robots.txt compliance</strong>
                            <div class="text-muted">Reads and respects <code>Disallow</code> rules before crawling any path</div>
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-diagram-3 text-info"></i>
                            <strong>Sitemap &amp; RSS discovery</strong>
                            <div class="text-muted">Auto-seeds the queue from <code>sitemap.xml</code>, <code>rss.xml</code>, <code>atom.xml</code></div>
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-link-45deg text-primary"></i>
                            <strong>HTML link extraction</strong>
                            <div class="text-muted">Parses <code>&lt;a href&gt;</code> tags via HtmlAgilityPack, same-domain only</div>
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-layers text-warning"></i>
                            <strong>Depth-limited crawling</strong>
                            <div class="text-muted">BFS with configurable <code>MaxDepth</code> and <code>MaxPages</code> guards</div>
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-speedometer text-danger"></i>
                            <strong>Adaptive rate limiting</strong>
                            <div class="text-muted">Adjusts delays based on server response times to avoid overloading hosts</div>
                        </li>
                        <li class="list-group-item">
                            <i class="bi bi-cpu text-secondary"></i>
                            <strong>Concurrent requests</strong>
                            <div class="text-muted">Configurable <code>MaxConcurrentRequests</code> for throughput control</div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-warning">
                    <h6 class="mb-0"><i class="bi bi-code-slash"></i> Usage Example</h6>
                </div>
                <div class="card-body">
                    <pre class="small bg-light p-2 rounded mb-0"><code>var result = await crawler.CrawlAsync(
    "https://markhazleton.com",
    new CrawlerOptions {
        MaxPages = 20,
        MaxDepth = 2,
        RespectRobotsTxt = true,
        DiscoverFromSitemapAndRss = true,
        RequestDelayMs = 300
    });</code></pre>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function () {
    'use strict';

    console.log('[Crawler] Script initializing');

    var crawlBtn       = document.getElementById('crawlBtn');
    var crawlingState  = document.getElementById('crawlingState');
    var crawlingMsg    = document.getElementById('crawlingMessage');
    var errorState     = document.getElementById('errorState');
    var errorMessage   = document.getElementById('errorMessage');
    var resultsState   = document.getElementById('resultsState');
    var crawlAgainBtn  = document.getElementById('crawlAgainBtn');

    if (!crawlBtn) {
        console.error('[Crawler] crawlBtn not found — aborting init');
        return;
    }

    console.log('[Crawler] All elements found, attaching handlers');

    function showOnly(el) {
        [crawlingState, errorState, resultsState].forEach(function (e) {
            if (e) { e.style.display = 'none'; }
        });
        if (el) { el.style.display = ''; }
    }

    function setLoading(url) {
        crawlBtn.disabled = true;
        crawlBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Crawling...';
        if (crawlingMsg) { crawlingMsg.textContent = 'Crawling ' + url + ' \u2014 please wait\u2026'; }
        showOnly(crawlingState);
    }

    function resetButton() {
        crawlBtn.disabled = false;
        crawlBtn.innerHTML = '<i class="bi bi-play-fill"></i> Start Crawl';
    }

    function formatMs(ms) {
        if (!ms || ms < 1000) { return (ms || 0) + 'ms'; }
        return (ms / 1000).toFixed(1) + 's';
    }

    function statusBadge(code, ok) {
        return '<span class="badge ' + (ok ? 'bg-success' : 'bg-danger') + '">' + code + '</span>';
    }

    function escHtml(str) {
        if (!str) { return ''; }
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderResults(data) {
        document.getElementById('statTotal').textContent    = data.totalPages;
        document.getElementById('statSuccess').textContent  = data.successCount;
        document.getElementById('statFailed').textContent   = data.failureCount;
        document.getElementById('statDuration').textContent = formatMs(data.durationMs);

        var badges = [];
        if (data.robotsTxtRespected) { badges.push('<span class="badge bg-success me-1"><i class="bi bi-shield-check"></i> robots.txt</span>'); }
        if (data.sitemapDiscovery)   { badges.push('<span class="badge bg-info text-dark me-1"><i class="bi bi-diagram-3"></i> sitemap/RSS</span>'); }
        badges.push('<span class="badge bg-secondary me-1">depth \u2264 ' + data.maxDepth + '</span>');
        badges.push('<span class="badge bg-secondary me-1">limit ' + data.maxPagesLimit + ' pages</span>');
        document.getElementById('metaBadges').innerHTML = badges.join('');

        var tbody = document.getElementById('resultsTableBody');
        tbody.innerHTML = '';

        if (!data.pages || data.pages.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">No pages returned.</td></tr>';
        } else {
            data.pages.forEach(function (p, i) {
                var urlCell = '<a href="' + escHtml(p.url) + '" target="_blank" rel="noopener" class="text-truncate d-block" style="max-width:340px">' + escHtml(p.url) + '</a>';
                if (p.title)  { urlCell += '<small class="text-muted">' + escHtml(p.title) + '</small>'; }
                if (p.errors) { urlCell += '<br><small class="text-danger"><i class="bi bi-exclamation-circle"></i> ' + escHtml(p.errors) + '</small>'; }

                tbody.insertAdjacentHTML('beforeend',
                    '<tr>'
                    + '<td class="text-muted">' + (i + 1) + '</td>'
                    + '<td>' + urlCell + '</td>'
                    + '<td class="text-center">' + statusBadge(p.statusCode, p.isSuccess) + '</td>'
                    + '<td class="text-center">' + p.depth + '</td>'
                    + '<td class="text-center">' + p.linksFound + '</td>'
                    + '<td class="text-end small text-muted">' + formatMs(p.elapsedMs) + '</td>'
                    + '</tr>');
            });
        }

        showOnly(resultsState);
        console.log('[Crawler] Results rendered: ' + data.totalPages + ' pages');
    }

    crawlBtn.addEventListener('click', function () {
        var url       = (document.getElementById('crawlUrl').value || '').trim();
        var maxPages  = parseInt(document.getElementById('maxPages').value, 10);
        var maxDepth  = parseInt(document.getElementById('maxDepth').value, 10);
        var robotsTxt = document.getElementById('robotsTxt').checked;
        var sitemap   = document.getElementById('sitemapDiscover').checked;

        console.log('[Crawler] Starting crawl:', url, 'maxPages:', maxPages, 'maxDepth:', maxDepth);

        if (!url) {
            alert('Please enter a URL.');
            return;
        }

        setLoading(url);

        fetch('/Crawler/Crawl', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url, maxPages: maxPages, maxDepth: maxDepth, respectRobotsTxt: robotsTxt, discoverFromSitemap: sitemap })
        })
        .then(function (res) {
            return res.json().then(function (body) { return { ok: res.ok, status: res.status, body: body }; });
        })
        .then(function (r) {
            resetButton();
            if (!r.ok) {
                var msg = (r.body && r.body.error) ? r.body.error : ('HTTP ' + r.status);
                console.error('[Crawler] Server error:', msg);
                if (errorMessage) { errorMessage.textContent = msg; }
                showOnly(errorState);
            } else {
                renderResults(r.body);
            }
        })
        .catch(function (err) {
            resetButton();
            console.error('[Crawler] Fetch error:', err);
            if (errorMessage) { errorMessage.textContent = err.message || 'Unexpected error'; }
            showOnly(errorState);
        });
    });

    if (crawlAgainBtn) {
        crawlAgainBtn.addEventListener('click', function () {
            showOnly(null);
            var urlInput = document.getElementById('crawlUrl');
            if (urlInput) { urlInput.focus(); }
        });
    }

    console.log('[Crawler] Ready');
});
</script>
}
