@{
    ViewData["Title"] = "Web Crawler";
}

<div class="row">
    <div class="col-lg-12">
        <h1 class="display-5">üï∑Ô∏è Web Crawler</h1>
        <p class="lead">@ViewData["Description"]</p>
        
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            <strong>Package Split Demo:</strong> This feature uses the <code>WebSpark.HttpClientUtility.Crawler</code> package,
            which extends the base package with web crawling capabilities.
        </div>
        
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Limitations:</strong> This crawler only works with <strong>server-rendered HTML</strong>. 
            Single Page Applications (SPAs) that use JavaScript frameworks like React, Vue, or Angular will not be crawled correctly. 
            Try sites like <code>https://example.com</code>, <code>https://httpbin.org/links/10</code>, or traditional server-rendered websites.
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Crawler Configuration</h5>
            </div>
            <div class="card-body">
                <form id="crawlerForm">
                    <div class="mb-3">
                        <label for="url" class="form-label">Start URL</label>
                        <input type="url" class="form-control" id="url" placeholder="https://example.com" value="https://example.com" required>
                        <div class="form-text">The URL to start crawling from</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="maxDepth" class="form-label">Max Depth</label>
                            <input type="number" class="form-control" id="maxDepth" value="2" min="1" max="10">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> Depth 1 = home, 2 = links from home, 3 = links from those pages
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="maxPages" class="form-label">Max Pages</label>
                            <input type="number" class="form-control" id="maxPages" value="20" min="1" max="1000">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> Crawler stops when this limit is reached
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="delayMs" class="form-label">Delay (ms)</label>
                            <input type="number" class="form-control" id="delayMs" value="100" min="100" max="5000" step="100">
                            <div class="form-text">Delay between requests</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="respectRobotsTxt" checked>
                                <label class="form-check-label" for="respectRobotsTxt">
                                    Respect robots.txt
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="discoverFromSitemap" checked>
                                <label class="form-check-label" for="discoverFromSitemap">
                                    <i class="bi bi-file-earmark-code"></i> Discover from sitemap/RSS
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="userAgent" class="form-label">User Agent</label>
                        <input type="text" class="form-control" id="userAgent" value="WebSpark.HttpClientUtility.Crawler/2.0.0">
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="startCrawlBtn">
                            <i class="bi bi-play-circle"></i> Start Crawl
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Real-Time Progress Section -->
        <div id="progressSection" class="mt-4" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> Crawling in Progress...</h5>
                </div>
                <div class="card-body">
                    <div class="progress" style="height: 30px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0%
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 mb-0" id="pagesCount">0</div>
                                <small class="text-muted">Pages Crawled</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 mb-0 text-success" id="successCount">0</div>
                                <small class="text-muted">Successful</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 mb-0 text-danger" id="failureCount">0</div>
                                <small class="text-muted">Failed</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 mb-0 text-warning" id="queueCount">0</div>
                                <small class="text-muted">In Queue</small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="currentUrl" class="mt-3 text-center">
                        <small class="text-muted">Ready to start...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Pages List -->
        <div id="livePagesSection" class="mt-4" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Crawled Pages (Live)</h5>
                    <button class="btn btn-sm btn-outline-light" id="clearPagesBtn">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="livePagesList" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                        <!-- Pages will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Results Section -->
        <div id="resultsSection" class="mt-4" style="display: none;">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-check-circle"></i> Crawl Complete</h5>
                </div>
                <div class="card-body">
                    <div id="crawlStatistics" class="mb-4"></div>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Features</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">‚úÖ <strong>Real-Time Page Tracking</strong></li>
                    <li class="mb-2">‚úÖ <strong>Robots.txt Compliance</strong></li>
                    <li class="mb-2">‚úÖ <strong>HTML Link Extraction</strong></li>
                    <li class="mb-2">‚úÖ <strong>Depth-Limited Crawling</strong></li>
                    <li class="mb-2">‚úÖ <strong>Live Statistics</strong></li>
                    <li class="mb-2">‚úÖ <strong>SignalR Progress Updates</strong></li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Best Practices</h5>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>Start with small max pages (20-50)</li>
                    <li>Use appropriate delays (1000ms+)</li>
                    <li>Always respect robots.txt</li>
                    <li>Monitor server load</li>
                    <li>Test on your own sites first</li>
                </ul>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-code-square"></i> Package Info</h5>
            </div>
            <div class="card-body">
                <p class="small mb-2"><strong>Base Package:</strong></p>
                <code class="d-block mb-3 small">WebSpark.HttpClientUtility</code>
                
                <p class="small mb-2"><strong>Crawler Package:</strong></p>
                <code class="d-block mb-3 small">WebSpark.HttpClientUtility.Crawler</code>
                
                <p class="small mb-0">
                    <strong>DI Registration:</strong>
                </p>
                <pre class="small"><code>services.AddHttpClientUtility();
services.AddHttpClientCrawler();</code></pre>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        console.log("[Crawler] Scripts section loaded - waiting for SignalR module to load...");
        
        // State management
        let connection;
        let crawledPagesMap = new Map();
        let crawlStartTime = null;
        
        // SignalR Event Handlers
        function handlePageCrawled(pageEvent) {
            console.log('[Crawler] PageCrawled event:', pageEvent);
            
            // Add to map
            crawledPagesMap.set(pageEvent.url, pageEvent);
            
            // Update live pages list
            addPageToLiveList(pageEvent);
        }
        
        function handleCrawlProgress(progressUpdate) {
            console.log('[Crawler] CrawlProgress event:', progressUpdate);
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            const percent = progressUpdate.progressPercentage || 0;
            
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.setAttribute('aria-valuenow', percent);
                progressBar.textContent = `${percent}%`;
            }
            
            // Update counters
            updateCounter('pagesCount', progressUpdate.pagesCrawled);
            updateCounter('successCount', progressUpdate.successfulPages);
            updateCounter('failureCount', progressUpdate.failedPages);
            updateCounter('queueCount', progressUpdate.pagesInQueue);
            
            // Update current URL
            const currentUrl = document.getElementById('currentUrl');
            if (currentUrl && progressUpdate.currentUrl) {
                currentUrl.innerHTML = `<small class="text-muted">Currently crawling: <strong>${truncateUrl(progressUpdate.currentUrl)}</strong></small>`;
            }
        }
        
        function handleCrawlStatistics(statistics) {
            console.log('[Crawler] CrawlStatistics event:', statistics);
            
            const statsDiv = document.getElementById('crawlStatistics');
            if (!statsDiv) return;
            
            const durationFormatted = formatDuration(statistics.duration);
            
            statsDiv.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h3 class="mb-0">${statistics.totalPages}</h3>
                                <small class="text-muted">Total Pages</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h3 class="mb-0 text-success">${statistics.successfulPages}</h3>
                                <small class="text-muted">Successful</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h3 class="mb-0 text-danger">${statistics.failedPages}</h3>
                                <small class="text-muted">Failed</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h3 class="mb-0">${statistics.pagesPerSecond.toFixed(2)}</h3>
                                <small class="text-muted">Pages/Sec</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-clock"></i> <strong>Duration:</strong> ${durationFormatted}
                </div>
            `;
        }
        
        function handleCrawlResults(results) {
            console.log('[Crawler] CrawlResults event:', results);
            
            const resultsContent = document.getElementById('resultsContent');
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');
            const startBtn = document.getElementById('startCrawlBtn');
            
            if (!resultsContent) return;
            
            // Build results table
            const tableRows = results.crawlResults && results.crawlResults.length > 0
                ? results.crawlResults.map((page, index) => {
                    const statusBadge = page.isSuccessStatusCode
                        ? `<span class="badge bg-success">${page.statusCode}</span>`
                        : `<span class="badge bg-danger">${page.statusCode}</span>`;

                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td class="text-truncate" style="max-width: 320px;">
                                <a href="${page.requestPath}" target="_blank" rel="noopener">${page.requestPath}</a>
                            </td>
                            <td>${statusBadge}</td>
                            <td>${page.pageTitle || 'Untitled'}</td>
                            <td>${page.depth || 0}</td>
                            <td>${page.linksFound || 0}</td>
                        </tr>`;
                }).join('')
                : '<tr><td colspan="6" class="text-center text-muted">No crawl results available.</td></tr>';

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>URL</th>
                                <th>Status</th>
                                <th>Title</th>
                                <th>Depth</th>
                                <th>Links</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>`;

            resultsContent.innerHTML = tableHtml;
            
            // Show results section and hide progress
            if (resultsSection) resultsSection.style.display = 'block';
            if (progressSection) progressSection.style.display = 'none';
            
            // Re-enable button
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Crawl';
            }
        }
        
        function handleCrawlError(error) {
            console.error('[Crawler] CrawlError event:', error);
            
            const resultsContent = document.getElementById('resultsContent');
            const resultsSection = document.getElementById('resultsSection');
            const progressSection = document.getElementById('progressSection');
            const startBtn = document.getElementById('startCrawlBtn');

            if (resultsContent && resultsSection) {
                resultsContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle"></i> Crawl Error</h5>
                        <p><strong>URL:</strong> ${error.url}</p>
                        <p><strong>Error:</strong> ${error.error}</p>
                        <p class="small mb-0">Timestamp: ${new Date(error.timestamp).toLocaleString()}</p>
                    </div>
                `;
                resultsSection.style.display = 'block';
            }
            
            if (progressSection) progressSection.style.display = 'none';
            
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Crawl';
            }
        }
        
        // UI Helper Functions
        function addPageToLiveList(pageEvent) {
            const livePagesList = document.getElementById('livePagesList');
            const livePagesSection = document.getElementById('livePagesSection');
            
            if (!livePagesList) return;
            
            // Show section if hidden
            if (livePagesSection && livePagesSection.style.display === 'none') {
                livePagesSection.style.display = 'block';
            }
            
            const statusBadge = pageEvent.isSuccess 
                ? `<span class="badge bg-success">${pageEvent.statusCode}</span>`
                : `<span class="badge bg-danger">${pageEvent.statusCode}</span>`;
            
            const pageItem = document.createElement('div');
            pageItem.className = 'list-group-item list-group-item-action';
            pageItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div class="flex-grow-1" style="min-width: 0;">
                        <h6 class="mb-1 text-truncate">${pageEvent.title || 'Untitled'}</h6>
                        <small class="text-muted text-truncate d-block">${pageEvent.url}</small>
                    </div>
                    <div class="ms-2 text-end">
                        ${statusBadge}
                        <small class="d-block text-muted">Depth: ${pageEvent.depth}</small>
                    </div>
                </div>
            `;
            
            // Add animation
            pageItem.style.opacity = '0';
            livePagesList.insertBefore(pageItem, livePagesList.firstChild);
            
            // Trigger animation
            setTimeout(() => {
                pageItem.style.transition = 'opacity 0.5s';
                pageItem.style.opacity = '1';
            }, 10);
            
            // Limit list to 50 items
            while (livePagesList.children.length > 50) {
                livePagesList.removeChild(livePagesList.lastChild);
            }
        }
        
        function updateCounter(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
        }
        
        function truncateUrl(url, maxLength = 50) {
            if (!url || url.length <= maxLength) return url;
            return url.substring(0, maxLength) + '...';
        }
        
        function formatDuration(duration) {
            if (!duration) return 'N/A';
            
            // Handle TimeSpan format from C# (e.g., "00:01:23.4567890")
            if (typeof duration === 'string') {
                const parts = duration.split(':');
                if (parts.length >= 3) {
                    const hours = parseInt(parts[0]);
                    const minutes = parseInt(parts[1]);
                    const seconds = Math.floor(parseFloat(parts[2]));
                    
                    if (hours > 0) {
                        return `${hours}h ${minutes}m ${seconds}s`;
                    } else if (minutes > 0) {
                        return `${minutes}m ${seconds}s`;
                    } else {
                        return `${seconds}s`;
                    }
                }
            }
            
            return duration;
        }
        
        function resetUI() {
            // Clear maps
            crawledPagesMap.clear();
            crawlStartTime = null;
            
            // Reset counters
            updateCounter('pagesCount', 0);
            updateCounter('successCount', 0);
            updateCounter('failureCount', 0);
            updateCounter('queueCount', 0);
            
            // Reset progress bar
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = '0%';
                progressBar.setAttribute('aria-valuenow', 0);
                progressBar.textContent = '0%';
            }
            
            // Clear current URL
            const currentUrl = document.getElementById('currentUrl');
            if (currentUrl) {
                currentUrl.innerHTML = '<small class="text-muted">Ready to start...</small>';
            }
            
            // Clear live pages list
            const livePagesList = document.getElementById('livePagesList');
            if (livePagesList) {
                livePagesList.innerHTML = '';
            }
            
            // Hide sections
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('livePagesSection').style.display = 'none';
        }
        
        // SignalR Initialization
        function initializeSignalR() {
            console.log("[Crawler] initializeSignalR called");
            
            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/crawlHub")
                    .withAutomaticReconnect()
                    .configureLogging(signalR.LogLevel.Information)
                    .build();

                console.log("[Crawler] SignalR connection object created");

                // Register event handlers
                connection.on("PageCrawled", handlePageCrawled);
                connection.on("CrawlProgress", handleCrawlProgress);
                connection.on("CrawlStatistics", handleCrawlStatistics);
                connection.on("CrawlResults", handleCrawlResults);
                connection.on("CrawlError", handleCrawlError);
                
                // Legacy handler for backward compatibility
                connection.on("UrlFound", function (message) {
                    console.log("[Crawler] SignalR UrlFound (legacy):", message);
                });

                console.log("[Crawler] Starting SignalR connection...");
                connection.start().then(() => {
                    console.log("[Crawler] ‚úÖ SignalR connected successfully!");
                    console.log("[Crawler] Connection ID:", connection.connectionId);
                }).catch(function (err) {
                    console.error("[Crawler] ‚ùå SignalR connection error:", err);
                });
            } catch (error) {
                console.error("[Crawler] ‚ùå Error initializing SignalR:", error);
            }
        }
        
        // Form Submission Handler
        async function handleCrawlerFormSubmit(e) {
            e.preventDefault();
            console.log("[Crawler] Form submitted");

            const startBtn = document.getElementById('startCrawlBtn');
            const progressSection = document.getElementById('progressSection');
            
            if (!startBtn) return;
            
            // Reset UI
            resetUI();
            
            // Get form values
            const request = {
                url: document.getElementById('url')?.value || '',
                maxDepth: parseInt(document.getElementById('maxDepth')?.value || '0', 10),
                maxPages: parseInt(document.getElementById('maxPages')?.value || '0', 10),
                delayMs: parseInt(document.getElementById('delayMs')?.value || '0', 10),
                respectRobotsTxt: document.getElementById('respectRobotsTxt')?.checked || false,
                discoverFromSitemap: document.getElementById('discoverFromSitemap')?.checked || false,
                userAgent: document.getElementById('userAgent')?.value || ''
            };

            if (!request.url) {
                alert('Please enter a valid URL');
                return;
            }

            console.log("[Crawler] Request:", request);

            // Show progress section
            if (progressSection) progressSection.style.display = 'block';

            // Disable button
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="bi bi-hourglass"></i> Crawling...';
            
            crawlStartTime = Date.now();

            try {
                const response = await fetch('/Crawler/Crawl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(request)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('[Crawler] Crawl initiated:', result);
            } catch (error) {
                console.error('[Crawler] Crawl error:', error);
                alert(`Error starting crawl: ${error.message}`);
                
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Crawl';
                
                if (progressSection) progressSection.style.display = 'none';
            }
        }
        
        // Wait for SignalR
        function waitForSignalR(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkSignalR = setInterval(() => {
                attempts++;
                if (typeof signalR !== 'undefined') {
                    clearInterval(checkSignalR);
                    console.log(`[Crawler] ‚úÖ SignalR loaded after ${attempts} checks`);
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkSignalR);
                    console.error(`[Crawler] ‚ùå SignalR failed to load after ${maxAttempts} attempts`);
                }
            }, 100);
        }
        
        // Page Initialization
        function initializeCrawlerPage() {
            console.log("[Crawler] Initializing crawler page...");
            waitForSignalR(initializeSignalR);

            const crawlerForm = document.getElementById('crawlerForm');
            if (crawlerForm) {
                crawlerForm.addEventListener('submit', handleCrawlerFormSubmit);
            }
            
            // Clear pages button
            const clearPagesBtn = document.getElementById('clearPagesBtn');
            if (clearPagesBtn) {
                clearPagesBtn.addEventListener('click', () => {
                    const livePagesList = document.getElementById('livePagesList');
                    if (livePagesList) {
                        livePagesList.innerHTML = '';
                    }
                });
            }
        }

        if (document.readyState === 'loading') {
            console.log("[Crawler] Waiting for DOM to finish loading...");
            document.addEventListener('DOMContentLoaded', initializeCrawlerPage);
        } else {
            initializeCrawlerPage();
        }
    </script>
}
